{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <!-- Header with back button -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <a href="{% url 'trade_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Journal
                    </a>
                </div>
                <h4 class="mb-0 text-muted">Trade Details</h4>
            </div>

            <!-- Trade Card -->
            <div class="card border-0 shadow-sm mb-4">
                <!-- Trade Header -->
                <div class="card-header bg-white border-0 py-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <h2 class="h1 fw-bold mb-0">{{ trade.symbol }}</h2>
                                <div class="d-flex gap-2">
                                    <span class="badge {% if trade.trade_type == 'BUY' %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %} px-3 py-2">
                                        <i class="bi {% if trade.trade_type == 'BUY' %}bi-arrow-up-circle{% else %}bi-arrow-down-circle{% endif %} me-1"></i>
                                        {{ trade.trade_type }}
                                    </span>
                                    <span class="badge {% if trade.status == 'OPEN' %}bg-primary-subtle text-primary{% else %}bg-secondary-subtle text-secondary{% endif %} px-3 py-2">
                                        {{ trade.status }}
                                    </span>
                                </div>
                            </div>
                            <p class="text-muted mb-0">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ trade.entry_date|date:"F d, Y - h:i A" }}
                            </p>
                        </div>
                        {% if trade.pnl %}
                        <div class="text-end">
                            <p class="text-muted small mb-1">P&L</p>
                            <h3 class="{% if trade.pnl > 0 %}text-success{% elif trade.pnl < 0 %}text-danger{% else %}text-muted{% endif %} mb-0 fw-bold">
                                {% if trade.pnl > 0 %}+{% endif %}Npr {{ trade.pnl|floatformat:2 }}
                            </h3>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Trade Body -->
                <div class="card-body p-0">
                    <!-- Main Details -->
                    <div class="row g-0">
                        <div class="col-md-6 p-4 border-end">
                            <h6 class="fw-bold text-primary mb-3">Entry Details</h6>
                            <div class="row g-3">
                                <div class="col-6">
                                    <p class="text-muted small mb-1">Entry Price</p>
                                    <p class="fw-semibold mb-0">Npr {{ trade.entry_price|floatformat:2 }}</p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">Quantity</p>
                                    <p class="fw-semibold mb-0">{{ trade.quantity }} units</p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">Stop Loss</p>
                                    <p class="fw-semibold mb-0">
                                        {% if trade.stop_loss %}
                                            Npr {{ trade.stop_loss|floatformat:2 }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">Target</p>
                                    <p class="fw-semibold mb-0">
                                        {% if trade.target %}
                                            Npr {{ trade.target|floatformat:2 }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 p-4">
                            <h6 class="fw-bold text-primary mb-3">Exit Details</h6>
                            <div class="row g-3">
                                <div class="col-6">
                                    <p class="text-muted small mb-1">Exit Price</p>
                                    <p class="fw-semibold mb-0">
                                        {% if trade.exit_price %}
                                            Npr {{ trade.exit_price|floatformat:2 }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">Exit Date</p>
                                    <p class="fw-semibold mb-0">
                                        {% if trade.exit_date %}
                                            {{ trade.exit_date|date:"M d, Y" }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">Strategy</p>
                                    <p class="fw-semibold mb-0">{{ trade.strategy.name|default:"-" }}</p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">Emotion</p>
                                    <p class="fw-semibold mb-0">{{ trade.get_emotion_display|default:"-" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    {% if trade.notes %}
                    <div class="border-top p-4">
                        <h6 class="fw-bold text-primary mb-3">Notes</h6>
                        <div class="bg-light rounded p-3">
                            <p class="mb-0">{{ trade.notes }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                <div class="card-footer bg-white border-0 p-4 pt-0">
                    <div class="d-flex justify-content-between flex-wrap gap-2">
                        <a href="{% url 'trade_list' %}" class="btn btn-outline-success">
                            <i class="bi bi-check2-circle"></i>Done
                        </a>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#tradeHistoryModal">
                                <i class="bi bi-archive me-2"></i>Trade & Charts
                            </button>
                            <a href="{% url 'trade_update' trade.pk %}" class="btn btn-light">
                                <i class="bi bi-pencil me-2"></i>Edit Trade
                            </a>
                            <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewDetailsModal">
                                <i class="bi bi-eye me-2"></i>View Details
                            </button>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadChartModal">
                                <i class="bi bi-image me-2"></i>Add Chart/Image
                            </button>
                            <a href="{% url 'trade_delete' trade.pk %}" class="btn btn-outline-danger">
                                <i class="bi bi-trash me-2"></i>Delete
                            </a>
                        </div>
                    </div>
                </div>

                <!-- View Details Modal -->
                <div class="modal fade" id="viewDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Trade Analysis - {{ trade.symbol }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-3">Trade Metrics</h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><span class="text-muted">Trade Type:</span> <strong>{{ trade.trade_type }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Entry Price:</span> <strong>Npr {{ trade.entry_price|floatformat:2 }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Exit Price:</span> <strong>{% if trade.exit_price %}Npr {{ trade.exit_price|floatformat:2 }}{% else %}-{% endif %}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Quantity:</span> <strong>{{ trade.quantity }} units</strong></li>
                                            {% if trade.pnl %}
                                            <li class="mb-2"><span class="text-muted">P&L:</span> <strong class="{% if trade.pnl > 0 %}text-success{% elif trade.pnl < 0 %}text-danger{% endif %}">{% if trade.pnl > 0 %}+{% endif %}Npr {{ trade.pnl|floatformat:2 }}</strong></li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-3">Risk Management</h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><span class="text-muted">Stop Loss:</span> <strong>{% if trade.stop_loss %}Npr {{ trade.stop_loss|floatformat:2 }}{% else %}-{% endif %}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Target:</span> <strong>{% if trade.target %}Npr {{ trade.target|floatformat:2 }}{% else %}-{% endif %}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Strategy:</span> <strong>{{ trade.strategy.name|default:"-" }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Emotion:</span> <strong>{{ trade.get_emotion_display|default:"-" }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Status:</span> <strong>{{ trade.status }}</strong></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trade & Charts Modal -->
                <div class="modal fade" id="tradeHistoryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-light">
                                <h5 class="modal-title">
                                    <i class="bi bi-archive me-2"></i>Trade Summary & Charts - {{ trade.symbol }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Trade Status Badge -->
                                <div class="mb-4">
                                    <span class="badge {% if trade.status == 'CLOSED' %}bg-success{% else %}bg-warning{% endif %} px-3 py-2 fs-6">
                                        <i class="bi {% if trade.status == 'CLOSED' %}bi-check-circle{% else %}bi-clock-history{% endif %} me-2"></i>
                                        {{ trade.status }} Trade
                                    </span>
                                    {% if trade.is_backtest %}
                                    <span class="badge bg-secondary px-3 py-2 ms-2">Backtest</span>
                                    {% endif %}
                                </div>

                                <!-- Trade Metrics -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-3">
                                            <i class="bi bi-graph-up me-2"></i>Trade Metrics
                                        </h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><span class="text-muted">Type:</span> <strong>{{ trade.trade_type }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Entry Price:</span> <strong>Npr {{ trade.entry_price|floatformat:2 }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Entry Date:</span> <strong>{{ trade.entry_date|date:"M d, Y H:i" }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Quantity:</span> <strong>{{ trade.quantity }} units</strong></li>
                                            {% if trade.exit_price %}
                                            <li class="mb-2"><span class="text-muted">Exit Price:</span> <strong>Npr {{ trade.exit_price|floatformat:2 }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Exit Date:</span> <strong>{{ trade.exit_date|date:"M d, Y H:i" }}</strong></li>
                                            {% endif %}
                                            {% if trade.pnl %}
                                            <li class="mb-0"><span class="text-muted">P&L:</span> <strong class="{% if trade.pnl > 0 %}text-success fs-5{% elif trade.pnl < 0 %}text-danger fs-5{% endif %}">{% if trade.pnl > 0 %}+{% endif %}Npr {{ trade.pnl|floatformat:2 }}</strong></li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-3">
                                            <i class="bi bi-shield-check me-2"></i>Risk Management
                                        </h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><span class="text-muted">Stop Loss:</span> <strong>{% if trade.stop_loss %}Npr {{ trade.stop_loss|floatformat:2 }}{% else %}<span class="text-muted">-</span>{% endif %}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Target:</span> <strong>{% if trade.target %}Npr {{ trade.target|floatformat:2 }}{% else %}<span class="text-muted">-</span>{% endif %}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Strategy:</span> <strong>{{ trade.strategy.name|default:"-" }}</strong></li>
                                            <li class="mb-2"><span class="text-muted">Emotion:</span> <strong>{{ trade.get_emotion_display|default:"-" }}</strong></li>
                                            {% if trade.trade_reason %}
                                            <li class="mb-0"><span class="text-muted">Reason:</span></li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>

                                <!-- Trade Reason -->
                                {% if trade.trade_reason %}
                                <div class="border-top pt-4 mb-4">
                                    <h6 class="fw-bold mb-3">
                                        <i class="bi bi-lightbulb me-2"></i>Trade Reason
                                    </h6>
                                    <div class="bg-light rounded p-3">
                                        <p class="mb-0">{{ trade.trade_reason }}</p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Notes -->
                                {% if trade.notes %}
                                <div class="border-bottom pb-4 mb-4">
                                    <h6 class="fw-bold mb-3">
                                        <i class="bi bi-journal-text me-2"></i> Trade Notes/Errors
                                    </h6>
                                    <div class="bg-light rounded p-3">
                                        <p class="mb-0">{{ trade.notes }}</p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Uploaded Charts/Images -->
                                <div id="tradeChartsSection">
                                    <h6 class="fw-bold mb-3">
                                        <i class="bi bi-image me-2"></i>Uploaded Charts & Images
                                    </h6>
                                    <div id="chartsContainer" class="row g-3">
                                        <div class="col-12 text-center py-4 text-muted">
                                            <i class="bi bi-image fs-1 d-block mb-2"></i>
                                            <p class="mb-0">No charts uploaded yet</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#uploadChartModal">
                                            <i class="bi bi-cloud-upload me-2"></i>Upload New Chart
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Chart/Image Modal -->
                <div class="modal fade" id="uploadChartModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Chart/Image to Trade</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="chartUploadForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="chartUpload" class="form-label">Upload Image</label>
                                        <input type="file" class="form-control" id="chartUpload" name="image" accept="image/*" required>
                                        <small class="text-muted">Supported formats: JPG, PNG, GIF, WebP</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="chartDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="chartDescription" name="caption" rows="3" placeholder="Add a description for this chart/image..."></textarea>
                                    </div>
                                    <div class="alert alert-info">
                                        <small><i class="bi bi-info-circle me-2"></i>This image will be attached to your trade record for future reference.</small>
                                    </div>
                                    <div id="uploadStatus"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary" id="uploadBtn">
                                        <i class="bi bi-cloud-upload me-2"></i>Upload Chart
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('chartUploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadChartModal = document.getElementById('uploadChartModal');
    const tradeHistoryModal = document.getElementById('tradeHistoryModal');
    const tradeId = {{ trade.pk }};
    
    // Load existing images on Trade & Charts modal open
    tradeHistoryModal.addEventListener('show.bs.modal', function() {
        loadTradeChartsForModal();
    });
    
    // Load existing images on upload modal open
    uploadChartModal.addEventListener('show.bs.modal', function() {
        loadTradeImages();
    });
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
        uploadStatus.innerHTML = '';
        
        fetch(`{% url 'upload_trade_chart' trade.pk %}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadStatus.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>' + data.message + '</div>';
                form.reset();
                setTimeout(() => {
                    uploadBtn.click(); // Keep modal open and reload
                    loadTradeChartsForModal();
                    loadTradeImages();
                }, 1500);
            } else {
                uploadStatus.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-circle me-2"></i>' + data.message + '</div>';
            }
        })
        .catch(error => {
            uploadStatus.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-circle me-2"></i>Error uploading file. Please try again.</div>';
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Upload Chart';
        });
    });
    
    // Load and display trade images for Trade & Charts modal
    function loadTradeChartsForModal() {
        fetch(`{% url 'trade_images' trade.pk %}`)
        .then(response => response.json())
        .then(data => {
            displayChartsInModal(data.images);
        })
        .catch(error => {
            console.error('Error loading charts:', error);
        });
    }
    
    // Display images in Trade & Charts modal
    function displayChartsInModal(images) {
        const chartsContainer = document.getElementById('chartsContainer');
        
        if (images.length === 0) {
            chartsContainer.innerHTML = `
                <div class="col-12 text-center py-4 text-muted">
                    <i class="bi bi-image fs-1 d-block mb-2"></i>
                    <p class="mb-0">No charts uploaded yet</p>
                </div>
            `;
            return;
        }
        
        let chartsHtml = '';
        images.forEach(img => {
            chartsHtml += `
                <div class="col-md-6">
                    <div class="card h-100">
                        <img src="${img.url}" class="card-img-top" alt="${img.caption}" style="height: 250px; object-fit: cover;">
                        <div class="card-body">
                            <p class="card-text"><small class="text-muted">${img.caption || 'Trade Chart'}</small></p>
                            <small class="text-secondary d-block mb-2">${img.created_at}</small>
                            <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="deleteChart(${img.id})">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        chartsContainer.innerHTML = chartsHtml;
    }
    
    // Load and display trade images for Upload modal
    function loadTradeImages() {
        fetch(`{% url 'trade_images' trade.pk %}`)
        .then(response => response.json())
        .then(data => {
            displayTradeImages(data.images);
        });
    }
    
    // Display images in upload modal
    function displayTradeImages(images) {
        if (images.length === 0) return;
        
        // Add images section to modal
        let imagesHtml = '<div class="mt-4"><h6 class="fw-bold mb-3">Uploaded Images</h6>';
        images.forEach(img => {
            imagesHtml += `
                <div class="card mb-2">
                    <div class="card-body">
                        <img src="${img.url}" class="img-fluid rounded mb-2" alt="${img.caption}" style="max-height: 200px;">
                        <p class="mb-1"><small class="text-muted">${img.caption || 'No description'}</small></p>
                        <small class="text-secondary">${img.created_at}</small>
                    </div>
                </div>
            `;
        });
        imagesHtml += '</div>';
        
        let imagesSection = document.getElementById('tradeImagesSection');
        if (!imagesSection) {
            imagesSection = document.createElement('div');
            imagesSection.id = 'tradeImagesSection';
            uploadChartModal.querySelector('.modal-body').appendChild(imagesSection);
        }
        imagesSection.innerHTML = imagesHtml;
    }
    
    // Delete chart function
    window.deleteChart = function(imageId) {
        if (confirm('Are you sure you want to delete this chart?')) {
            fetch(`{% url 'delete_trade_image' trade.pk 0 %}`.replace('0', imageId), {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTradeChartsForModal();
                    loadTradeImages();
                }
            })
            .catch(error => console.error('Error:', error));
        }
    };
});
</script>
{% endblock %}